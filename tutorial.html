
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutorial &#8212; diepvries  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced topics" href="advanced-topics.html" />
    <link rel="prev" title="Installation" href="installation.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">diepvries</a></h1>



<p class="blurb">Data Vault framework in Python</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="naming-conventions.html">Naming conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-model">Data model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#customers">Customers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orders">Orders</a></li>
<li class="toctree-l3"><a class="reference internal" href="#link">Link</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#extraction-table">Extraction table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#loading-data">Loading data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced-topics.html">Advanced topics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">API documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="installation.html" title="previous chapter">Installation</a></li>
      <li>Next: <a href="advanced-topics.html" title="next chapter">Advanced topics</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will go over the creation of Data Vault
structures, and their automatic loading through the framework.</p>
<p>Some pre-requisites are required to get started:</p>
<ul class="simple">
<li><p>General knowledge about the <a class="reference external" href="https://en.wikipedia.org/wiki/Data_vault_modeling">Data Vault 2.0</a> modeling
technique.</p></li>
<li><p><a class="reference internal" href="installation.html"><span class="doc">A working installation of diepvries</span></a>.</p></li>
<li><p>An access to a <a class="reference external" href="https://docs.snowflake.com/en/user-guide-getting-started.html">Snowflake instance</a>.</p></li>
</ul>
<p>You should also create a database and schemas to host the various
structures and data:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">diepvries_tutorial</span><span class="p">;</span>
<span class="n">USE</span> <span class="k">DATABASE</span> <span class="n">diepvries_tutorial</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">SCHEMA</span> <span class="n">dv</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">SCHEMA</span> <span class="n">dv_extract</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">SCHEMA</span> <span class="n">dv_staging</span><span class="p">;</span>
</pre></div>
</div>
<p>Three schemas are used in this example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dv</span></code>: Where the Data Vault model is stored.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dv_extract</span></code>: Where the raw, extracted data lies. The tables it
contains are used as input to the framework.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dv_staging</span></code>: Staging area for data, used internally by the
framework.</p></li>
</ul>
<div class="section" id="data-model">
<h2>Data model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h2>
<p>Let’s assume a simple data model consisting of customers and
orders. We need Data Vault entities to represent them, let’s dive into
their creation and some naming conventions.</p>
<div class="section" id="customers">
<h3>Customers<a class="headerlink" href="#customers" title="Permalink to this headline">¶</a></h3>
<p>We start with customers:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_customer</span> <span class="p">(</span>
  <span class="n">h_customer_hashkey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashkey&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp</span>        <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_source</span>           <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record source&#39;</span><span class="p">,</span>
  <span class="n">customer_id</span>        <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Customer business ID&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">h_customer_hashkey</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">dv</span><span class="p">.</span><span class="n">hs_customer</span> <span class="p">(</span>
  <span class="n">h_customer_hashkey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_customer</span> <span class="p">(</span><span class="n">h_customer_hashkey</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashkey&#39;</span><span class="p">,</span>
  <span class="n">s_hashdiff</span>         <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashdiff&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp</span>        <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record start timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp_end</span>    <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record end timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_source</span>           <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record source&#39;</span><span class="p">,</span>
  <span class="n">firstname</span>          <span class="nb">VARCHAR</span> <span class="k">COMMENT</span> <span class="s1">&#39;Customer first name&#39;</span><span class="p">,</span>
  <span class="n">lastname</span>           <span class="nb">VARCHAR</span> <span class="k">COMMENT</span> <span class="s1">&#39;Customer last name&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">h_customer_hashkey</span><span class="p">,</span> <span class="n">r_timestamp</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>We created two tables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dv.h_customer</span></code>: A hub, whose table name is prefixed with
<code class="docutils literal notranslate"><span class="pre">h_</span></code>. It contains multiple columns:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">h_customer_hashkey</span></code>: The hashkey for this entity. It is the
primary key for this table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r_timestamp</span></code>: The creation timestamp for a record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r_source</span></code>: The data source for a record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">customer_id</span></code>: The business key for a record.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">dv.hs_customer</span></code>: A hub satellite, whose table name is prefixed
with <code class="docutils literal notranslate"><span class="pre">hs_</span></code>. It contains multiple columns:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">h_customer_hashkey</span></code>: The foreign key pointing to the hub.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s_hashdiff</span></code>: The hashdiff for a record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r_timestamp</span></code>: The start timestamp for a record, it represents
the beginning of that record’s validity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r_timestamp_end</span></code>: The end timestamp for a record, it represents
the end of that record’s validity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r_source</span></code>: The data source for a record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">firstname</span></code> and <code class="docutils literal notranslate"><span class="pre">lastname</span></code>: Some actual values, and not
metadata. They are the first and last names of a customer.</p></li>
</ul>
</li>
</ul>
<p>The primary key for the hub satellite is <code class="docutils literal notranslate"><span class="pre">(h_customer_hashkey,</span>
<span class="pre">r_timestamp)</span></code>: The combination of a hub record and a given
timestamp.</p>
<p>At this point, you might have noticed the strong use of <a class="reference internal" href="naming-conventions.html"><span class="doc">naming
conventions</span></a>, with prefixes and suffixes.</p>
</div>
<div class="section" id="orders">
<h3>Orders<a class="headerlink" href="#orders" title="Permalink to this headline">¶</a></h3>
<p>Following those principles, let’s create a hub and a hub satellite to
represent orders:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_order</span> <span class="p">(</span>
  <span class="n">h_order_hashkey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashkey&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp</span>     <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_source</span>        <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record source&#39;</span><span class="p">,</span>
  <span class="n">order_id</span>        <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Order business ID&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">h_order_hashkey</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">dv</span><span class="p">.</span><span class="n">hs_order</span> <span class="p">(</span>
  <span class="n">h_order_hashkey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_order</span> <span class="p">(</span><span class="n">h_order_hashkey</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashkey&#39;</span><span class="p">,</span>
  <span class="n">s_hashdiff</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashdiff&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp</span>     <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record start timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp_end</span> <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record end timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_source</span>        <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record source&#39;</span><span class="p">,</span>
  <span class="n">create_ts</span>       <span class="k">TIMESTAMP</span> <span class="k">COMMENT</span> <span class="s1">&#39;Order creation timestamp&#39;</span><span class="p">,</span>
  <span class="n">quantity</span>        <span class="nb">INTEGER</span> <span class="k">COMMENT</span> <span class="s1">&#39;Order quantity&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">h_order_hashkey</span><span class="p">,</span> <span class="n">r_timestamp</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>This is of course a simplified model: we assume a business selling
only one product to customers; who can buy a different quantity of
that product.</p>
</div>
<div class="section" id="link">
<h3>Link<a class="headerlink" href="#link" title="Permalink to this headline">¶</a></h3>
<p>The next step is to link customers and orders together. Let’s create a
link:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">dv</span><span class="p">.</span><span class="n">l_order_customer</span> <span class="p">(</span>
  <span class="n">l_order_customer_hashkey</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record hashkey&#39;</span><span class="p">,</span>
  <span class="n">h_customer_hashkey</span>       <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_customer</span> <span class="p">(</span><span class="n">h_customer_hashkey</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="s1">&#39;Customer hashkey&#39;</span><span class="p">,</span>
  <span class="n">h_order_hashkey</span>          <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_order</span> <span class="p">(</span><span class="n">h_order_hashkey</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="s1">&#39;Order hashkey&#39;</span><span class="p">,</span>
  <span class="n">customer_id</span>              <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Customer business ID&#39;</span><span class="p">,</span>
  <span class="n">order_id</span>                 <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Order business ID&#39;</span><span class="p">,</span>
  <span class="n">r_timestamp</span>              <span class="k">TIMESTAMP</span>   <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record timestamp&#39;</span><span class="p">,</span>
  <span class="n">r_source</span>                 <span class="nb">VARCHAR</span>     <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;Record source&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">l_article_price_hashkey</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Of course, if that link had fields associated with it, we would create
a link satellite. But for the purpose of this tutorial we will skip
this part.</p>
</div>
</div>
<div class="section" id="extraction-table">
<h2>Extraction table<a class="headerlink" href="#extraction-table" title="Permalink to this headline">¶</a></h2>
<p>The framework assumes you have raw data somewhere in a table,
extracted from an operational system. For the purpose of this
tutorial, let’s generate some data. We’ll pretend it comes from the
operational system handling customers and orders.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">TABLE</span> <span class="n">dv_extract</span><span class="p">.</span><span class="n">order_customer</span> <span class="p">(</span>
  <span class="n">customer_id</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">firstname</span>   <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">lastname</span>    <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">order_id</span>    <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">create_ts</span>   <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">quantity</span>    <span class="nb">VARCHAR</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dv_extract</span><span class="p">.</span><span class="n">order_customer</span>
<span class="k">VALUES</span>
  <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-03-17T14:00:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-03-17T15:00:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-03-17T16:00:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-03-17T17:00:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-03-17T18:00:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dv_extract</span><span class="p">.</span><span class="n">order_customer</span><span class="p">;</span>
</pre></div>
</div>
<p>Notice the last item: <code class="docutils literal notranslate"><span class="pre">customer_id</span></code> and <code class="docutils literal notranslate"><span class="pre">lastname</span></code> are
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>. diepvries graciously handles <code class="docutils literal notranslate"><span class="pre">NULL</span></code> values, as we’ll see
further in this tutorial.</p>
</div>
<div class="section" id="loading-data">
<h2>Loading data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>Now comes the interesting part. We have prepared hubs and hub
satellites for customers and orders, and have raw data waiting to be
ingested in the Data Vault! Everything is set up for the framework to
do its magic.</p>
<p>Let’s move from SQL to Python, and have a look at this script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>

<span class="kn">from</span> <span class="nn">diepvries.data_vault_load</span> <span class="kn">import</span> <span class="n">DataVaultLoad</span>
<span class="kn">from</span> <span class="nn">diepvries.deserializers.snowflake_deserializer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatabaseConfiguration</span><span class="p">,</span>
    <span class="n">SnowflakeDeserializer</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_load_sql</span><span class="p">():</span>
    <span class="c1"># Configuration for the Snowflake connection</span>
    <span class="n">database_configuration</span> <span class="o">=</span> <span class="n">DatabaseConfiguration</span><span class="p">(</span>
        <span class="n">database</span><span class="o">=</span><span class="s2">&quot;diepvries_tutorial&quot;</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;&lt;YOUR USER&gt;&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;&lt;YOUR PASSWORD&gt;&quot;</span><span class="p">,</span>
        <span class="n">warehouse</span><span class="o">=</span><span class="s2">&quot;&lt;YOUR WAREHOUSE&gt;&quot;</span><span class="p">,</span>
        <span class="n">account</span><span class="o">=</span><span class="s2">&quot;&lt;YOUR SNOWFLAKE ACCOUNT NAME&gt;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Automatically deserialize known Data Vault tables</span>
    <span class="n">deserializer</span> <span class="o">=</span> <span class="n">SnowflakeDeserializer</span><span class="p">(</span>
        <span class="n">target_schema</span><span class="o">=</span><span class="s2">&quot;dv&quot;</span><span class="p">,</span>
        <span class="n">target_tables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;h_customer&quot;</span><span class="p">,</span> <span class="s2">&quot;hs_customer&quot;</span><span class="p">,</span> <span class="s2">&quot;h_order&quot;</span><span class="p">,</span> <span class="s2">&quot;hs_order&quot;</span><span class="p">],</span>
        <span class="n">database_configuration</span><span class="o">=</span><span class="n">database_configuration</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Prepare data load</span>
    <span class="n">dv_load</span> <span class="o">=</span> <span class="n">DataVaultLoad</span><span class="p">(</span>
        <span class="n">extract_schema</span><span class="o">=</span><span class="s2">&quot;dv_extract&quot;</span><span class="p">,</span>
        <span class="n">extract_table</span><span class="o">=</span><span class="s2">&quot;order_customer&quot;</span><span class="p">,</span>
        <span class="n">staging_schema</span><span class="o">=</span><span class="s2">&quot;dv_staging&quot;</span><span class="p">,</span>
        <span class="n">staging_table</span><span class="o">=</span><span class="s2">&quot;order_customer&quot;</span><span class="p">,</span>
        <span class="n">extract_start_timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">target_tables</span><span class="o">=</span><span class="n">deserializer</span><span class="o">.</span><span class="n">deserialized_target_tables</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Data from diepvries tutorial&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Show generated SQL statements</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">dv_load</span><span class="o">.</span><span class="n">sql_load_script</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">get_load_sql</span><span class="p">()</span>
</pre></div>
</div>
<p>This is the source code to ingest into the Data Vault the data coming
from our (fake) operational system. It concerns both entities,
customers, and orders, hence will load data into both hubs and both
satellites.</p>
<p>A few things are going on in this script:</p>
<ul class="simple">
<li><p>We prepare a
<a class="reference internal" href="api/diepvries.deserializers.snowflake_deserializer.html#diepvries.deserializers.snowflake_deserializer.DatabaseConfiguration" title="diepvries.deserializers.snowflake_deserializer.DatabaseConfiguration"><code class="xref py py-class docutils literal notranslate"><span class="pre">DatabaseConfiguration</span></code></a>
to hold the Snowflake parameters.</p></li>
<li><p>We instantiate a
<a class="reference internal" href="api/diepvries.deserializers.snowflake_deserializer.html#diepvries.deserializers.snowflake_deserializer.SnowflakeDeserializer" title="diepvries.deserializers.snowflake_deserializer.SnowflakeDeserializer"><code class="xref py py-class docutils literal notranslate"><span class="pre">SnowflakeDeserializer</span></code></a>. This
object will deserialize the given tables into Python objects,
through Snowflake introspection. We gave as a parameter the list of
target tables we’re interested in, the 2 hubs and the 2 hub
satellites.</p></li>
<li><p>We instantiate a
<a class="reference internal" href="api/diepvries.data_vault_load.html#diepvries.data_vault_load.DataVaultLoad" title="diepvries.data_vault_load.DataVaultLoad"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataVaultLoad</span></code></a>. This is
the main entry point to the framework. Let’s look at its parameters:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_schema</span></code>: The schema where the raw data lives,
<code class="docutils literal notranslate"><span class="pre">dv_extract</span></code> in our case.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_table</span></code>: The table that actually contains the raw data,
the one we created earlier: <code class="docutils literal notranslate"><span class="pre">order_customer</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">staging_schema</span></code>: The stating aread, used internally by the
framework. We created <code class="docutils literal notranslate"><span class="pre">dv_staging</span></code> for that purpose.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">staging_table</span></code>: The table used for storing staging data. It
needs to be unique for each Data Vault script, in our case we
chose the name <code class="docutils literal notranslate"><span class="pre">order_customer</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extract_start_timestamp</span></code>: The extract timestamp, i.e. now, the
time when the data is loaded into the Data Vault. It needs to be
timezone-aware.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_tables</span></code>: The list of target tables. We computed it
earlier with the Snowflake deserializer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span></code>: The source of the data.</p></li>
</ul>
</li>
</ul>
<p>After filling in the correct credentials for your Snowflake account,
you can run this script. Be sure to execute it in the virtual
environment where diepvries is installed, so it can be imported.</p>
<p>Et voilà! The Python script will print out all the SQL statements
needed to load <code class="docutils literal notranslate"><span class="pre">h_customer</span></code>, <code class="docutils literal notranslate"><span class="pre">hs_customer</span></code>, <code class="docutils literal notranslate"><span class="pre">h_order</span></code> and
<code class="docutils literal notranslate"><span class="pre">hs_order</span></code> with the data from <code class="docutils literal notranslate"><span class="pre">dv_extract.order_customer</span></code>.</p>
<p>After executing those, you should inspect the content of the tables:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_customer</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dv</span><span class="p">.</span><span class="n">hs_customer</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dv</span><span class="p">.</span><span class="n">h_order</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dv</span><span class="p">.</span><span class="n">hs_order</span><span class="p">;</span>
</pre></div>
</div>
<p>Notice how <code class="docutils literal notranslate"><span class="pre">h_customer</span></code> has a row with the value <code class="docutils literal notranslate"><span class="pre">dv_unknown</span></code> for
the column <code class="docutils literal notranslate"><span class="pre">customer_id</span></code>. This is the ghost record, automatically
created by diepvries due to a row in the input data having <code class="docutils literal notranslate"><span class="pre">NULL</span></code> as
<code class="docutils literal notranslate"><span class="pre">customer_id</span></code>. This happens for business IDs; other NULLable columns
will retain <code class="docutils literal notranslate"><span class="pre">NULL</span></code> values.</p>
<p>Most of the content of the Python script is unrelated to the data
being loaded and the targeted Data Vault structures. This is the basic
recipe you can use for loading data from multiple sources to multiple
targets; with a few adaptations it can easily be configured to load
all your data.</p>
<p>How you organize and orchestrate multiple sources is up to you;
diepvries provides the building blocks, allowing more flexibility into
what you build with it.</p>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>Hungry for more? Head over the <a class="reference internal" href="advanced-topics.html"><span class="doc">advanced topics</span></a> or dive into the <a class="reference internal" href="api/modules.html"><span class="doc">API documentation</span></a>!</p>
</div>
</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;Picnic Technologies.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/tutorial.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>